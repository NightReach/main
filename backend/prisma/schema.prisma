datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

////////////////////
// USER & AUTH
////////////////////

model User {
  id            String                   @id @default(cuid())
  email         String                   @unique
  password      String
  role          String // ADMIN | PUBLISHER | ADVERTISER
  createdAt     DateTime                 @default(now())
  emailVerified Boolean                  @default(false)
  websites      Website[]
  campaigns     Campaign[]
  resetTokens   PasswordResetToken[]
  emailTokens   EmailVerificationToken[]
  isDisabled    Boolean  @default(false) // ðŸ‘ˆ ADD THIS
}

////////////////////
// WEBSITES & ZONES
////////////////////

model Website {
  id              String   @id @default(cuid())
  domain          String
  reviveWebsiteId Int
  userId          String
  createdAt       DateTime @default(now())

  user   User    @relation(fields: [userId], references: [id])
  zones  Zone[]
  clicks Click[]
}

model Zone {
  id           String   @id @default(cuid())
  websiteId    String
  reviveZoneId Int
  width        Int
  height       Int
  createdAt    DateTime @default(now())

  website       Website        @relation(fields: [websiteId], references: [id], onDelete: Cascade)
  campaignZones CampaignZone[]
  clicks        Click[]
  FraudEvent    FraudEvent[]

  @@index([websiteId])
}

////////////////////
// CAMPAIGNS
////////////////////

model Campaign {
  id     String @id @default(cuid())
  userId String

  name             String
  status           String @default("ACTIVE") // ACTIVE | PAUSED
  reviveCampaignId Int

  payoutType  String // CPC | CPA | CPM
  payoutValue Float

  forcePaused Boolean @default(false) // Phase 4.5

  createdAt DateTime @default(now())

  user           User             @relation(fields: [userId], references: [id])
  campaignZones  CampaignZone[]
  clicks         Click[]
  conversions    Conversion[]
  fraudEvents    FraudEvent[]
  AdminActionLog AdminActionLog[]
}

model CampaignZone {
  id         String @id @default(cuid())
  campaignId String
  zoneId     String

  campaign Campaign @relation(fields: [campaignId], references: [id])
  zone     Zone     @relation(fields: [zoneId], references: [id])

  @@unique([campaignId, zoneId])
}

////////////////////
// TRACKING
////////////////////

model Click {
  id         String @id @default(cuid())
  campaignId String
  zoneId     String
  websiteId  String

  ip        String
  userAgent String
  referer   String?
  createdAt DateTime @default(now())

  campaign    Campaign     @relation(fields: [campaignId], references: [id])
  zone        Zone         @relation(fields: [zoneId], references: [id])
  website     Website      @relation(fields: [websiteId], references: [id])
  conversions Conversion[]
  FraudEvent  FraudEvent[]
}

model Conversion {
  id         String   @id @default(cuid())
  campaignId String
  clickId    String   @unique
  payout     Float
  createdAt  DateTime @default(now())

  click    Click    @relation(fields: [clickId], references: [id])
  campaign Campaign @relation(fields: [campaignId], references: [id])
}

////////////////////
// STATS
////////////////////

model DailyStat {
  id   String   @id @default(cuid())
  date DateTime

  userId     String
  campaignId String?
  zoneId     String?

  clicks      Int   @default(0)
  conversions Int   @default(0)
  revenue     Float @default(0)

  createdAt DateTime @default(now())

  @@unique([date, userId, campaignId, zoneId])
  @@index([userId, date])
}

////////////////////
// FRAUD & SAFETY
////////////////////

model FraudEvent {
  id       String @id @default(cuid())
  type     String // IP_REPEAT | UA_REPEAT | FAST_CONVERSION | CR_ANOMALY
  severity Int // 1â€“5

  userId     String?
  campaignId String?
  zoneId     String?
  clickId    String?

  ip        String?
  userAgent String?
  meta      String? // JSON string

  createdAt DateTime @default(now())

  campaign Campaign? @relation(fields: [campaignId], references: [id])
  zone     Zone?     @relation(fields: [zoneId], references: [id])
  click    Click?    @relation(fields: [clickId], references: [id])

  @@index([type])
  @@index([campaignId])
  @@index([zoneId])
}

////////////////////
// ADMIN AUDIT LOG
////////////////////

model AdminActionLog {
  id         String   @id @default(cuid())
  adminId    String
  action     String // FORCE_PAUSE | FORCE_RESUME
  campaignId String
  reason     String?
  createdAt  DateTime @default(now())

  campaign Campaign @relation(fields: [campaignId], references: [id])
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}
